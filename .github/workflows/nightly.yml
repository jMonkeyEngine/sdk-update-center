name: Nightly Generation

on:
  push:
    branches: [ nightly ]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    # First download _this_ branch, because it contains the SDK target commit
    - uses: actions/checkout@v2
      with:
        path: ci
    - name: Load SDK Target Commit hash
      run: chmod u+x ci/target && ./ci/target

    # Then checkout the correct commit
    - uses: actions/checkout@v2
      with:
        repository: 'jMonkeyEngine/sdk'
        ref: ${{ env.sdk_sha }}
      
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        distribution: temurin
        java-version: 17
      
    - name: Grant execute permission for gradle
      run: chmod +x gradlew
      
    - name: Build the SDK
      run: ./gradlew buildSdk
      
    - name: Build Nightly NBMs
      env:
        NBM_SIGN_PASS: ${{ secrets.NBM_SIGN_PASS }}
      # For Stable, use set-spec-version
      run: ant -Dstorepass="$NBM_SIGN_PASS" -Dcatalog.base.url=https://github.com/jMonkeyEngine/sdk-update-center/releases/download/nightly_${{ github.run_number }} set-impl-version suite.nbms unset-impl-version
      
    - name: Upload nbms
      uses: softprops/action-gh-release@v1
      with:
        files: build/updates/*.nbm
        body: Nightlies built from commit [${{ env.sdk_sha }}](https://github.com/jMonkeyEngine/sdk/commit/${{ env.sdk_sha }})
        tag_name: nightly_${{ github.run_number }}
        name: "Master Nightlies #${{ github.run_number }}"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Checkout the XML Repository
      uses: actions/checkout@v2
      with:
        ref: nightly-xml
        path: xml
      
    - name: Setup Git for the commit
      run: git config user.email MeFisto94@users.noreply.github.com && git config user.name MeFisto94
      working-directory: xml
      
    - name: Overwrite the updates.xml
      # \cp to prevent an alias to cp -i (interactive)
      run: \cp -rf build/updates/updates.xml xml/updates.xml
      
    - name: Commit the updates.xml
      working-directory: ./xml
      run: git add updates.xml && git commit -m "Updating the nightlies to https://github.com/jMonkeyEngine/sdk/commit/${{ env.sdk_sha }}" && git push
